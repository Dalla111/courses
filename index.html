<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Resource Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --brand-color: #4f46e5; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .font-serif { font-family: 'Lora', serif; }
        .view { display: none; animation: fadeIn 0.5s ease-in-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 5px solid #e5e7eb; border-radius: 50%; border-top: 5px solid var(--brand-color); width: 50px; height: 50px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card-hover { transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .card-hover:hover { transform: translateY(-6px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
        .item-hover { border-left: 4px solid transparent; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .item-hover:hover { background-color: #f4f4f5; border-left-color: var(--brand-color); }
        #pdf-viewer-overlay { transition: opacity 0.3s ease-in-out; }
        .pin-btn { transition: color 0.2s ease-in-out; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" id="home-link" class="flex items-center space-x-3">
                <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                </svg>
                <div>
                    <h1 class="text-2xl font-extrabold text-indigo-600 font-serif">Courses.</h1>
                </div>
            </a>
            <div id="breadcrumb" class="hidden md:flex items-center space-x-2 text-sm text-slate-500 flex-shrink min-w-0"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-container" class="container mx-auto p-4 md:p-8">
        <div id="loader" class="flex flex-col items-center justify-center min-h-[50vh]">
            <div class="loader"></div>
            <p class="mt-4 text-slate-500">Loading resources...</p>
        </div>

        <!-- View: Course Selection -->
        <div id="courses-view" class="view">
            <div class="text-center mb-12">
                <h2 class="text-4xl md:text-5xl font-bold font-serif mb-2">Select a Course</h2>
                <p class="text-lg text-slate-600 max-w-2xl mx-auto">Choose a course to view its materials, announcements, and resources.</p>
            </div>
             <div class="mb-8 max-w-2xl mx-auto">
                 <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                    <input type="text" id="course-search-input" placeholder="Search for a course..." class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-full bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 sm:text-sm shadow-sm">
                </div>
            </div>
            <div id="pinned-courses-container" class="hidden">
                 <h3 class="text-2xl font-bold font-serif mb-4 text-slate-700">Pinned Courses</h3>
                 <div id="pinned-courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12"></div>
            </div>
            <h3 class="text-2xl font-bold font-serif mb-4 text-slate-700">All Courses</h3>
            <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- View: Course Materials -->
        <div id="materials-view" class="view">
            <div id="materials-header" class="mb-6"></div>
            <div class="mb-8 max-w-2xl mx-auto">
                 <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                    <input type="text" id="search-input" placeholder="Search current folder..." class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-full bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 sm:text-sm shadow-sm">
                </div>
            </div>
            <div id="folders-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6"></div>
            <div id="files-list" class="bg-white rounded-lg shadow-md overflow-hidden divide-y divide-slate-100 mt-8"></div>
            <p id="no-results-message" class="text-center text-slate-500 mt-8 hidden">No matching items found.</p>
        </div>
    </main>

    <!-- PDF Viewer Overlay -->
    <div id="pdf-viewer-overlay" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center p-4">
        <div class="w-full h-full flex flex-col bg-slate-800 rounded-lg shadow-2xl">
            <div class="flex justify-between items-center p-3 border-b border-slate-600">
                <h3 id="pdf-title" class="font-semibold text-white truncate"></h3>
                <button id="close-pdf-viewer" class="text-white hover:text-red-500 transition-colors p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <iframe id="pdf-iframe" class="w-full h-full" frameborder="0"></iframe>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       // --- CONFIG ---
// This line will ONLY work when deployed to Cloudflare. 
// It reads the configuration securely injected by the _middleware.js file.
const firebaseConfig = window.firebaseConfig;
const appId = 'c_456bd6f038809860_course-admin-final-650'; // Your fixed app ID

// --- INITIALIZATION ---
let db;
try {
    // This will throw an error locally, which is expected.
    // It will succeed when deployed because window.firebaseConfig will exist.
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
} catch (e) {
    console.error("Firebase initialization failed.", e);
    // Display a user-friendly message
    const loader = document.getElementById('loader');
    if(loader) {
        loader.innerHTML = '<p class="text-red-500 font-semibold">Error: Could not connect to the database. This app must be run from its deployed Cloudflare URL.</p>';
    }
}

        const ui = {
            loader: document.getElementById('loader'),
            breadcrumb: document.getElementById('breadcrumb'),
            views: {
                courses: document.getElementById('courses-view'),
                materials: document.getElementById('materials-view'),
            },
            coursesGrid: document.getElementById('courses-grid'),
            pinnedCoursesContainer: document.getElementById('pinned-courses-container'),
            pinnedCoursesGrid: document.getElementById('pinned-courses-grid'),
            courseSearchInput: document.getElementById('course-search-input'),
            materialsHeader: document.getElementById('materials-header'),
            foldersGrid: document.getElementById('folders-grid'),
            filesList: document.getElementById('files-list'),
            searchInput: document.getElementById('search-input'),
            noResultsMessage: document.getElementById('no-results-message'),
            pdfOverlay: document.getElementById('pdf-viewer-overlay'),
            pdfIframe: document.getElementById('pdf-iframe'),
            pdfTitle: document.getElementById('pdf-title'),
            closePdfBtn: document.getElementById('close-pdf-viewer'),
            homeLink: document.getElementById('home-link'),
        };

        let allCourses = [];
        let currentCourse = null;
        let currentPath = []; // Array of {id, name} objects

        // --- PINNING LOGIC ---
        const getPinnedCourses = () => JSON.parse(localStorage.getItem('pinnedCourses') || '[]');
        const setPinnedCourses = (pinned) => localStorage.setItem('pinnedCourses', JSON.stringify(pinned));
        
        const togglePin = (courseId) => {
            let pinned = getPinnedCourses();
            if (pinned.includes(courseId)) {
                pinned = pinned.filter(id => id !== courseId);
            } else {
                pinned.push(courseId);
            }
            setPinnedCourses(pinned);
            renderCourseSelection(); // Re-render to show changes
        };

        // --- ROUTING ---
        const parseHash = () => {
            const params = new URLSearchParams(window.location.hash.substring(1));
            const courseId = params.get('course');
            const pathStr = params.get('path');
            const path = pathStr ? pathStr.split(';').map(p => {
                const [id, name] = p.split(':');
                return { id, name: decodeURIComponent(name) };
            }) : [];
            return { courseId, path };
        };

        const updateHash = () => {
            if (!currentCourse) {
                window.location.hash = '';
                return;
            }
            const pathStr = currentPath.map(p => `${p.id}:${encodeURIComponent(p.name)}`).join(';');
            const params = new URLSearchParams({ course: currentCourse.id });
            if (pathStr) {
                params.set('path', pathStr);
            }
            window.location.hash = params.toString();
        };
        
        const router = async () => {
            const { courseId, path } = parseHash();
            if (courseId) {
                if (allCourses.length === 0) await fetchCourses();
                currentCourse = allCourses.find(c => c.id === courseId);
                if (currentCourse) {
                    await renderCourseMaterials(path);
                    showView('materials');
                } else {
                    navigateToHome();
                }
            } else {
                await renderCourseSelection();
                showView('courses');
            }
        };

        const showView = (viewName) => {
            Object.values(ui.views).forEach(v => v.classList.remove('active'));
            if (ui.views[viewName]) {
                ui.views[viewName].classList.add('active');
                ui.loader.style.display = 'none';
            }
            ui.breadcrumb.classList.toggle('hidden', viewName === 'courses');
        };
        
        const navigateToHome = () => {
            currentCourse = null;
            currentPath = [];
            updateHash();
        };

        // --- DATA FETCHING ---
        const fetchCourses = async () => {
            if (!db) return;
            const coursesRef = collection(db, `artifacts/${appId}/public/data/courses`);
            const snapshot = await getDocs(coursesRef);
            allCourses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        };

        // --- RENDERING ---
        const renderCourseSelection = async () => {
            if (allCourses.length === 0) await fetchCourses();
            
            const query = ui.courseSearchInput.value.toLowerCase().trim();
            const pinnedIds = getPinnedCourses();
            
            const filteredCourses = allCourses.filter(c => c.name.toLowerCase().includes(query));
            
            const pinnedCourses = filteredCourses.filter(c => pinnedIds.includes(c.id));
            const unpinnedCourses = filteredCourses.filter(c => !pinnedIds.includes(c.id));

            ui.pinnedCoursesGrid.innerHTML = '';
            ui.coursesGrid.innerHTML = '';
            
            if (pinnedCourses.length > 0) {
                ui.pinnedCoursesContainer.style.display = 'block';
                pinnedCourses.forEach(course => createCourseCard(course, ui.pinnedCoursesGrid, true));
            } else {
                ui.pinnedCoursesContainer.style.display = 'none';
            }
            
            if (unpinnedCourses.length === 0 && pinnedCourses.length === 0) {
                 ui.coursesGrid.innerHTML = `<p class="text-slate-500 md:col-span-2 lg:col-span-3 text-center">No courses found.</p>`;
            } else {
                unpinnedCourses.forEach(course => createCourseCard(course, ui.coursesGrid, false));
            }

            updateHeader();
        };

        const createCourseCard = (course, grid, isPinned) => {
            const courseCard = document.createElement('div');
            courseCard.className = 'card-hover bg-white p-6 rounded-xl shadow-md flex flex-col items-start text-left relative';
            
            const pinIcon = isPinned 
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>`;

            courseCard.innerHTML = `
                <button class="pin-btn absolute top-4 right-4 text-indigo-500 hover:text-indigo-700 z-10">${pinIcon}</button>
                <a href="#" class="w-full h-full">
                    <div class="p-3 bg-indigo-100 rounded-lg mb-4 inline-block">
                        <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h12A2.25 2.25 0 0120.25 6v3.776" /></svg>
                    </div>
                    <h3 class="font-bold text-xl text-slate-800">${course.name}</h3>
                    <p class="text-slate-500 text-sm mt-1">${course.description || ''}</p>
                </a>
            `;
            courseCard.querySelector('a').addEventListener('click', (e) => {
                e.preventDefault();
                currentCourse = course;
                currentPath = [];
                updateHash();
            });
            courseCard.querySelector('.pin-btn').addEventListener('click', () => togglePin(course.id));
            grid.appendChild(courseCard);
        };

        const renderCourseMaterials = async (path) => {
            currentPath = path;
            updateHeader();
            ui.searchInput.value = '';

            let parentDocRef;
            if (path.length === 0) {
                parentDocRef = doc(db, `artifacts/${appId}/public/data/courses`, currentCourse.id);
            } else {
                const pathSegments = path.flatMap(p => ['folders', p.id]);
                parentDocRef = doc(db, `artifacts/${appId}/public/data/courses`, currentCourse.id, ...pathSegments);
            }

            const foldersRef = collection(parentDocRef, 'folders');
            const filesRef = collection(parentDocRef, 'files');

            const [foldersSnapshot, filesSnapshot] = await Promise.all([getDocs(foldersRef), getDocs(filesRef)]);
            
            const folders = foldersSnapshot.docs.map(d => ({...d.data(), id: d.id})).sort((a,b) => a.name.localeCompare(b.name));
            const files = filesSnapshot.docs.map(d => ({...d.data(), id: d.id})).sort((a,b) => a.name.localeCompare(b.name));

            ui.foldersGrid.innerHTML = '';
            ui.filesList.innerHTML = '';

            folders.forEach(folder => {
                const folderEl = document.createElement('a');
                folderEl.className = 'card-hover bg-white p-5 rounded-xl shadow-md cursor-pointer flex flex-col items-center text-center';
                folderEl.dataset.name = folder.name;
                folderEl.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 text-indigo-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                    <h3 class="font-bold text-md text-slate-700 break-all">${folder.name}</h3>`;
                folderEl.addEventListener('click', e => {
                    e.preventDefault();
                    currentPath.push({ id: folder.id, name: folder.name });
                    updateHash();
                });
                ui.foldersGrid.appendChild(folderEl);
            });

            files.forEach(file => {
                const fileEl = document.createElement('a');
                fileEl.href = file.link;
                fileEl.target = "_blank";
                fileEl.className = `item-hover p-4 flex items-center justify-between space-x-4 cursor-pointer`;
                fileEl.dataset.name = file.name;
                fileEl.innerHTML = `
                    <div class="flex items-center space-x-4 min-w-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        <span class="font-medium text-slate-700 truncate">${file.name}</span>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>`;
                ui.filesList.appendChild(fileEl);
            });
            
            handleSearch();
        };
        
        const updateHeader = () => {
            if (currentCourse) {
                ui.materialsHeader.innerHTML = `<h2 class="text-3xl md:text-4xl font-bold font-serif mb-2">${currentCourse.name}</h2><p class="text-lg text-slate-600">${currentCourse.description || ''}</p>`;
                
                // Breadcrumb
                let breadcrumbHTML = `<a href="#" id="bc-home" class="hover:text-indigo-600">Courses</a>`;
                let tempPath = [];
                currentPath.forEach((segment, index) => {
                    tempPath.push(segment);
                    const isLast = index === currentPath.length - 1;
                    const pathStr = tempPath.map(p => `${p.id}:${encodeURIComponent(p.name)}`).join(';');
                    breadcrumbHTML += `<span class="text-slate-400 mx-1">/</span>`;
                    if (isLast) {
                        breadcrumbHTML += `<span class="font-semibold text-slate-700 truncate">${segment.name}</span>`;
                    } else {
                        breadcrumbHTML += `<a href="#course=${currentCourse.id}&path=${pathStr}" class="hover:text-indigo-600 truncate">${segment.name}</a>`;
                    }
                });
                ui.breadcrumb.innerHTML = breadcrumbHTML;
                document.getElementById('bc-home').addEventListener('click', e => { e.preventDefault(); navigateToHome(); });

            } else {
                ui.materialsHeader.innerHTML = '';
                ui.breadcrumb.innerHTML = '';
            }
        };

        // --- SEARCH ---
        const handleSearch = () => {
            const query = ui.searchInput.value.toLowerCase().trim();
            let hasResults = false;

            const filterItems = (selector) => {
                document.querySelectorAll(selector).forEach(item => {
                    const name = item.dataset.name.toLowerCase();
                    const isVisible = name.includes(query);
                    item.classList.toggle('hidden', !isVisible);
                    if (isVisible) hasResults = true;
                });
            };

            filterItems('#folders-grid > a');
            filterItems('#files-list > a');

            ui.noResultsMessage.classList.toggle('hidden', hasResults);
        };

        // --- EVENT LISTENERS ---
        window.addEventListener('hashchange', router);
        window.addEventListener('load', router);
        ui.homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            navigateToHome();
        });
        ui.searchInput.addEventListener('input', handleSearch);
        ui.courseSearchInput.addEventListener('input', renderCourseSelection);

    </script>
</body>
</html>



